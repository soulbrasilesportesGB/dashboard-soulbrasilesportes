
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard – Treinos (Externos)</title>
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 8px; }
    .controls { display: grid; grid-template-columns: repeat(6, minmax(0, 1fr)); gap: 12px; margin: 16px 0 24px; }
    .card { border: 1px solid #e5e7eb; border-radius: 14px; padding: 16px; margin-bottom: 16px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid #f1f5f9; font-size: 14px; text-align: left; }
    th { background: #f8fafc; position: sticky; top: 0; }
    .status-ok { color: #065f46; background: #ecfdf5; padding: 2px 8px; border-radius: 999px; font-weight: 600; }
    .status-att { color: #92400e; background: #fffbeb; padding: 2px 8px; border-radius: 999px; font-weight: 600; }
    .status-risk { color: #991b1b; background: #fef2f2; padding: 2px 8px; border-radius: 999px; font-weight: 600; }
    .muted { color: #6b7280; }
    .badge { display:inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; margin-right:6px; margin-bottom: 4px; border: 1px solid #e5e7eb; }
    .badge-red { background:#fef2f2; color:#991b1b; border-color:#fecaca; }
    .badge-amber { background:#fffbeb; color:#92400e; border-color:#fde68a; }
    .badge-green { background:#ecfdf5; color:#065f46; border-color:#bbf7d0; }
    .flex { display:flex; gap:12px; align-items:center; }
    .actions button { padding: 10px 12px; border: 1px solid #e5e7eb; background: white; border-radius: 10px; cursor: pointer; }
    .actions button:hover { background: #f8fafc; }
    .drill { margin-top: 12px; }
    .small { font-size: 12px; }
    .search { grid-column: span 2 / span 2; }
    .insights-box { margin-top: 10px; padding: 12px; border:1px dashed #e5e7eb; border-radius: 12px; background:#fafafa; }
    .insights-box h4 { margin: 0 0 8px; }
    .insight-item { margin: 4px 0; }
    .error { color:#991b1b; background:#fef2f2; border:1px solid #fecaca; padding:8px 12px; border-radius:10px; margin:12px 0; display:none; }
  </style>
</head>
<body>
  <h1>Treinos (externos) — visão geral</h1>
  <div class="muted small">Fonte: base completa sem corte de dias. Filtros aplicáveis abaixo.</div>
  <div id="err" class="error"></div>

  <div class="controls">
    <div>
      <label>De</label>
      <input type="date" id="startDate" />
    </div>
    <div>
      <label>Até</label>
      <input type="date" id="endDate" />
    </div>
    <div>
      <label>Atleta</label>
      <select id="athleteSelect">
        <option value="">Todos</option>
      </select>
    </div>
    <div class="search">
      <label>Buscar por nome</label>
      <input type="text" id="searchBox" placeholder="Digite para filtrar…" />
    </div>
    <div class="actions">
      <label>&nbsp;</label><br />
      <button id="applyFilter">Aplicar filtros</button>
      <button id="resetFilter">Limpar</button>
    </div>
  </div>

  <div class="card">
    <table id="insightsTable">
      <thead>
        <tr>
          <th>Atleta</th>
          <th>Modalidade</th>
          <th>Sessões</th>
          <th>Nota média</th>
          <th>Sent. antes</th>
          <th>Sent. depois</th>
          <th>Δ humor</th>
          <th>Freq./semana</th>
          <th>Status</th>
          <th>Flags</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card drill" id="drillCard" style="display:none;">
    <div class="flex" style="justify-content: space-between;">
      <div>
        <div class="muted small">Sessões do atleta (respeitando filtros)</div>
        <h3 id="drillTitle" style="margin: 6px 0 0;"></h3>
      </div>
      <div class="muted small" id="drillCount"></div>
    </div>
    <div class="insights-box" id="athleteInsights" style="display:none;">
      <h4>Insights do atleta</h4>
      <div id="insightsList"></div>
    </div>
    <div style="overflow:auto; max-height: 50vh; margin-top: 8px;">
      <table id="baseTable">
        <thead>
          <tr>
            <th>Data</th>
            <th>Modalidade</th>
            <th>Duração</th>
            <th>Intensidade</th>
            <th>Mente</th>
            <th>Lesão</th>
            <th>Nota</th>
            <th>Sent. antes</th>
            <th>Sent. depois</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    let INSIGHTS = [];
    let BASE = [];

    const insightsBody = document.querySelector("#insightsTable tbody");
    const baseBody = document.querySelector("#baseTable tbody");
    const selectAthlete = document.getElementById("athleteSelect");
    const searchBox = document.getElementById("searchBox");
    const startDate = document.getElementById("startDate");
    const endDate = document.getElementById("endDate");
    const drillCard = document.getElementById("drillCard");
    const drillTitle = document.getElementById("drillTitle");
    const drillCount = document.getElementById("drillCount");
    const athleteInsights = document.getElementById("athleteInsights");
    const insightsList = document.getElementById("insightsList");
    const err = document.getElementById("err");

    function statusPill(s) { 
      if (s === "OK") return '<span class="status-ok">OK</span>';
      if (s === "Atenção") return '<span class="status-att">Atenção</span>';
      return '<span class="status-risk">Risco</span>';
    }
    function flagBadge(text) { 
      const t = (text||'').trim().toLowerCase();
      let cls = 'badge-amber';
      if (t.includes('baixa assiduidade') || (t.includes('humor') && (t.includes('não') || t.includes('nao')))) cls = 'badge-red';
      if (t.includes('nota') && t.includes('boa')) cls = 'badge-green';
      return `<span class="badge ${cls}">${text}</span>`;
    }
    function renderFlags(flagsStr) { if (!flagsStr) return ''; return flagsStr.split(',').map(f => flagBadge(f.trim())).join(' '); }
    function formatNum(x, d=2) { if (x === null || x === undefined || isNaN(x)) return "—"; return Number(x).toFixed(d).replace(".", ","); }
    function parseISO(d) { if (!d) return null; try { return new Date(d); } catch(e){ return null; } }
    function withinDateRange(isoDate, start, end) {
      if (!isoDate) return true; const t = parseISO(isoDate); if (!t) return true;
      if (start && t < start) return false; if (end && t > end) return false; return true;
    }
    function athleteKey(name) { return (name||'').toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g,''); }

    function buildAthleteInsights(r) {
      const msgs = [];
      if (r.freq_semana < 0.25) msgs.push(`Baixa consistência (${formatNum(r.freq_semana,2)}/semana). Priorizar 2x/sem com blocos curtos.`);
      else if (r.freq_semana < 0.5) msgs.push(`Consistência abaixo do ideal (${formatNum(r.freq_semana,2)}/semana).`);
      else msgs.push(`Boa consistência (${formatNum(r.freq_semana,2)}/semana).`);

      if (r.delta_sent <= 0) msgs.push(`Humor não melhora após os treinos (Δ ${formatNum(r.delta_sent,2)}). Rever carga/rotina de recuperação.`);
      else if (r.delta_sent >= 0.5) msgs.push(`Boa resposta emocional pós-treino (Δ ${formatNum(r.delta_sent,2)}).`);

      if (r.media_nota < 3) msgs.push(`Qualidade percebida baixa (nota média ${formatNum(r.media_nota,2)}).`);
      else if (r.media_nota >= 4) msgs.push(`Qualidade percebida boa (nota média ${formatNum(r.media_nota,2)}).`);

      if (r.sessoes <= 2) msgs.push(`Poucas sessões registradas (${r.sessoes}).`);

      if (r.modalidade_treino) msgs.push(`Foco principal em ${r.modalidade_treino}.`);
      return msgs;
    }

    function populateAthletes() {
      const athletes = [...new Set(INSIGHTS.map(r => r.Atleta))].sort();
      selectAthlete.innerHTML = '<option value=\"\">Todos</option>';
      athletes.forEach(a => { const opt = document.createElement('option'); opt.value = a; opt.textContent = a; selectAthlete.appendChild(opt); });
    }

    function applyFilters() {
      const nameQuery = (searchBox.value || "").toLowerCase();
      const selAthlete = selectAthlete.value;
      let rows = INSIGHTS.filter(r => {
        const nameOk = !nameQuery || (r.Atleta || "").toLowerCase().includes(nameQuery);
        const athleteOk = !selAthlete || r.Atleta === selAthlete;
        return nameOk && athleteOk;
      });

      insightsBody.innerHTML = "";
      rows.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><a href="#" data-athlete="${r.Atleta}">${r.Atleta}</a></td>
          <td>${r.modalidade_treino || "—"}</td>
          <td>${r.sessoes}</td>
          <td>${formatNum(r.media_nota, 2)}</td>
          <td>${formatNum(r.media_sent_antes, 2)}</td>
          <td>${formatNum(r.media_sent_depois, 2)}</td>
          <td>${formatNum(r.delta_sent, 2)}</td>
          <td>${formatNum(r.freq_semana, 2)}</td>
          <td>${statusPill(r.status)}</td>
          <td>${renderFlags(r.flags)}</td>
        `;
        insightsBody.appendChild(tr);
      });

      insightsBody.querySelectorAll("a[data-athlete]").forEach(a => {
        a.addEventListener("click", (e) => {
          e.preventDefault();
          const who = a.getAttribute("data-athlete");
          const row = INSIGHTS.find(x => x.Atleta === who);
          showDrill(who, row);
        });
      });
    }

    function showDrill(athlete, row) {
      drillCard.style.display = "block";
      drillTitle.textContent = athlete;

      const msgs = buildAthleteInsights(row);
      insightsList.innerHTML = msgs.map(m => `<div class="insight-item">• ${m}</div>`).join('');
      athleteInsights.style.display = msgs.length ? 'block' : 'none';

      const sd = startDate.value ? new Date(startDate.value) : null;
      const ed = endDate.value ? new Date(endDate.value) : null;

      const key = athleteKey(athlete);
      const sessions = BASE.filter(r => {
        const root = (r.usuario || "").split("@")[0].replaceAll(".", " ").toLowerCase();
        const norm = root.normalize("NFD").replace(/[\\u0300-\\u036f]/g,"");
        const dateOk = withinDateRange(r.data_treino, sd, ed);
        return norm === key && dateOk;
      });

      drillCount.textContent = sessions.length + " sessão(ões)";
      baseBody.innerHTML = "";
      sessions.sort((a,b) => {
        const ta = a.data_treino ? new Date(a.data_treino).getTime() : 0;
        const tb = b.data_treino ? new Date(b.data_treino).getTime() : 0;
        return tb - ta;
      }).forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${s.data_treino ? s.data_treino.substring(0,10) : "—"}</td>
          <td>${s.modalidade || "—"}</td>
          <td>${s.duracao || "—"}</td>
          <td>${s.intensidade || "—"}</td>
          <td>${s.mente || "—"}</td>
          <td>${s.lesao || "—"}</td>
          <td>${s.nota ?? "—"}</td>
          <td>${s.sent_antes ?? "—"}</td>
          <td>${s.sent_depois ?? "—"}</td>
        `;
        baseBody.appendChild(tr);
      });
    }

    document.getElementById("applyFilter").addEventListener("click", (e)=>{ e.preventDefault(); applyFilters(); });
    document.getElementById("resetFilter").addEventListener("click", (e)=>{ e.preventDefault();
      startDate.value = ""; endDate.value = ""; selectAthlete.value = ""; searchBox.value = "";
      drillCard.style.display = "none"; insightsList.innerHTML = ""; athleteInsights.style.display = "none"; baseBody.innerHTML = "";
      applyFilters();
    });

    async function boot() {
      try {
        const [insightsResp, baseResp] = await Promise.all([
          fetch('insights.json'), 
          fetch('base.json')
        ]);
        if (!insightsResp.ok || !baseResp.ok) throw new Error('Falha ao carregar JSON (verifique se os três arquivos estão na mesma pasta)');
        INSIGHTS = await insightsResp.json();
        BASE = await baseResp.json();
        populateAthletes();
        applyFilters();
      } catch (e) {
        err.style.display = 'block';
        err.textContent = e.message;
        console.error(e);
      }
    }

    boot();
  </script>
</body>
</html>
